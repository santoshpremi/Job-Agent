<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Job Agent - Three Column Layout</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      /* Import Google Fonts for better typography */
      @import url("https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap");

      /* Base typography system */
      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        font-weight: 400;
        font-size: 0.85rem;
        line-height: 1.5;
        color: #212529;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          "Helvetica Neue", Arial, sans-serif;
        background: #f8f9fa;
        min-height: 100vh;
        color: #1a1a1a;
        line-height: 1.4;
        font-size: 13px;
      }

      .app-container {
        display: flex;
        height: 100vh;
        overflow: hidden;
      }

      /* Left Sidebar - History */
      .left-sidebar {
        width: 300px;
        background: #ffffff;
        border-right: 1px solid #dee2e6;
        overflow-y: auto;
        padding: 15px;
        flex-shrink: 0;
      }

      .left-sidebar h2 {
        color: #212529;
        font-size: 1.1rem;
        margin-bottom: 20px;
        font-weight: 500;
        padding-bottom: 10px;
        border-bottom: 2px solid #0d6efd;
      }

      .history-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 12px;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        margin-bottom: 8px;
        background: #ffffff;
        transition: all 0.15s ease;
      }

      .history-item:hover {
        background: #f8f9fa;
        border-color: #adb5bd;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      }

      .history-item.viewing {
        background: #e7f3ff;
        border-color: #0d6efd;
        border-left: 3px solid #0d6efd;
      }

      .history-info h4 {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0 0 3px 0;
        color: #1a1a1a;
        font-size: 0.75rem;
        font-weight: 600;
        line-height: 1.2;
        letter-spacing: -0.01em;
      }

      .history-info p {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        color: #495057;
        font-size: 0.65rem;
        line-height: 1.3;
      }

      .history-actions {
        position: relative;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .download-toggle {
        background: none;
        color: #6c757d;
        border: none;
        padding: 3px 6px;
        font-size: 0.7rem;
        cursor: pointer;
        transition: all 0.15s ease;
        font-weight: 400;
        min-width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .download-toggle:hover {
        color: #495057;
      }

      .delete-btn {
        background: none;
        color: #dc3545;
        border: none;
        padding: 3px 6px;
        font-size: 0.7rem;
        cursor: pointer;
        transition: all 0.15s ease;
        font-weight: 400;
        min-width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      .delete-btn:hover {
        color: #c82333;
      }

      .download-options {
        position: absolute;
        top: 100%;
        left: 0;
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        display: none;
        z-index: 1000;
        min-width: 120px;
      }

      .download-options.show {
        display: block;
      }

      .download-btn {
        display: block;
        width: 100%;
        padding: 8px 12px;
        border: none;
        background: none;
        color: #495057;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        text-decoration: none;
        text-align: left;
        border-bottom: 1px solid #f1f3f4;
        line-height: 1.3;
      }

      .download-btn:last-child {
        border-bottom: none;
      }

      .download-btn:hover {
        background: #f8f9fa;
        color: #212529;
      }

      .download-btn.txt {
        background: #34a853;
        color: white;
      }

      .download-btn.csv {
        background: #34a853;
        color: white;
      }

      .download-btn.excel {
        background: #4285f4;
        color: white;
      }

      .download-btn.pdf {
        background: #ea4335;
        color: white;
      }

      /* Main Content Area */
      .main-content {
        flex: 1;
        background: #fafbfc;
        padding: 20px;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
      }

      .header {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        color: #1a1a1a;
        padding: 24px 32px;
        text-align: center;
        border-radius: 8px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      }

      .header h1 {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        font-size: 1.5rem;
        margin-bottom: 6px;
        font-weight: 700;
        color: #1a1a1a;
        letter-spacing: -0.02em;
        line-height: 1.2;
      }

      .header p {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        font-size: 0.8rem;
        color: #6c757d;
        margin: 0;
        font-weight: 400;
        line-height: 1.4;
      }

      .search-section {
        background: #ffffff;
        padding: 20px;
        border-radius: 6px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
      }

      .search-section h2 {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        color: #1a1a1a;
        font-size: 1.1rem;
        margin-bottom: 16px;
        font-weight: 600;
        letter-spacing: -0.015em;
        line-height: 1.3;
      }

      .search-form {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
      }

      .form-group {
        margin: 0;
        flex: 1;
        min-width: 120px;
      }

      .form-group.full-width {
        flex: 0 0 auto;
        min-width: 100px;
      }

      .form-group label {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        display: block;
        margin-bottom: 4px;
        font-weight: 600;
        color: #495057;
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.6px;
        line-height: 1.2;
      }

      .form-group input,
      .form-group select {
        width: 100%;
        padding: 6px 10px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 0.8rem;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        font-weight: 400;
        transition: all 0.15s ease;
        background: #ffffff;
        color: #212529;
        line-height: 1.3;
      }

      .form-group input:focus,
      .form-group select:focus {
        outline: none;
        border-color: #0d6efd;
        box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.1);
      }

      .search-btn {
        background: rgba(13, 110, 253, 0.8);
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s ease;
        min-width: 100px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1.3;
        letter-spacing: 0.01em;
      }

      .search-btn:hover {
        background: rgba(13, 110, 253, 0.9);
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(13, 110, 253, 0.25);
      }

      .history-viewer {
        background: #ffffff;
        padding: 20px;
        border-radius: 6px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        flex: 1;
        overflow-y: auto;
      }

      .history-viewer-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
      }

      .history-viewer-header h2 {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        margin: 0;
        color: #1a1a1a;
        font-size: 1.25rem;
        font-weight: 600;
        flex: 1;
        line-height: 1.3;
        letter-spacing: -0.01em;
      }

      .history-viewer-header h2:contains("Viewing:") {
        color: #0d6efd;
        font-weight: 600;
      }

      .close-viewer-btn {
        background: rgba(13, 110, 253, 0.8);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.8rem;
        cursor: pointer;
        transition: all 0.15s ease;
      }

      .close-viewer-btn:hover {
        background: rgba(13, 110, 253, 0.9);
      }

      .history-viewer-content {
        font-size: 0.875rem;
        line-height: 1.6;
        color: #495057;
      }

      .history-file-info {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 4px;
        margin-bottom: 20px;
        border: 1px solid #dee2e6;
      }

      .history-file-info h3 {
        margin: 0 0 10px 0;
        color: #212529;
        font-size: 1rem;
        font-weight: 500;
      }

      .history-file-info p {
        margin: 5px 0;
        font-size: 0.8rem;
      }

      .history-jobs-table {
        margin-top: 20px;
      }

      .history-raw-content h4 {
        margin: 15px 0 10px 0;
        color: #212529;
        font-size: 0.9rem;
        font-weight: 500;
      }

      .search-btn:disabled {
        background: rgba(13, 110, 253, 0.4);
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .agent-workflow {
        background: #f8f9fa;
        padding: 16px;
        border-radius: 6px;
        margin-bottom: 20px;
        display: none;
        font-size: 0.875rem;
        border: 1px solid #dee2e6;
      }

      .workflow-step {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        padding: 12px 16px;
        background: white;
        border-radius: 6px;
        border-left: 3px solid #dee2e6;
        transition: all 0.2s ease;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        font-size: 0.9rem;
        line-height: 1.4;
      }

      .workflow-step.active {
        border-left-color: #0d6efd;
        background: #f8f9fa;
      }

      .workflow-step.completed {
        border-left-color: #198754;
        background: #f0f8f0;
      }

      .step-icon {
        width: 18px;
        height: 18px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-right: 10px;
        font-size: 0.75rem;
        font-weight: 600;
      }

      .step-icon.pending {
        background: #dee2e6;
        color: #495057;
      }

      .step-icon.active {
        background: #0d6efd;
        color: white;
        animation: cursor-blink 1.2s infinite;
      }

      .step-icon.completed {
        background: #198754;
        color: white;
      }

      .step-content h4 {
        margin: 0 0 2px 0;
        color: #212529;
        font-size: 0.875rem;
        font-weight: 500;
      }

      .step-content p {
        color: #495057;
        font-size: 0.75rem;
        margin: 0;
      }

      .results-section {
        display: none;
        background: #ffffff;
        border-radius: 6px;
        border: 1px solid #dee2e6;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
        overflow: visible;
        max-height: none;
      }

      .results-section.processing {
        display: block;
      }

      .results-section.complete {
        display: block;
      }

      .export-buttons {
        display: flex;
        gap: 6px;
      }

      .export-btn {
        padding: 4px 10px;
        border: none;
        border-radius: 3px;
        font-weight: 400;
        cursor: pointer;
        transition: all 0.15s ease;
        text-decoration: none;
        display: inline-block;
        font-size: 0.75rem;
      }

      .export-btn:hover {
        transform: translateY(-1px);
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }

      .export-btn.csv {
        background: rgba(13, 110, 253, 0.8);
        color: white;
      }

      .export-btn.excel {
        background: rgba(13, 110, 253, 0.8);
        color: white;
      }

      .export-btn.pdf {
        background: rgba(13, 110, 253, 0.8);
        color: white;
      }

      .job-count {
        background: #e7f3ff;
        color: #0c63e4;
        padding: 12px 16px;
        border-radius: 6px 6px 0 0;
        text-align: left;
        margin-bottom: 0;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        font-size: 0.8rem;
        font-weight: 600;
        border-bottom: 1px solid #b6d4fe;
      }

      .table-container {
        overflow-x: auto;
        overflow-y: auto;
        max-height: 600px;
        background: white;
        border-radius: 0 0 6px 6px;
      }

      .results-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
      }

      .results-table th {
        background: #f8f9fa;
        color: #1a1a1a;
        padding: 8px 6px;
        text-align: left;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        font-weight: 600;
        font-size: 0.7rem;
        border-bottom: 1px solid #dee2e6;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        line-height: 1.2;
      }

      .results-table td {
        padding: 8px 6px;
        border-bottom: 1px solid #f1f3f4;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        font-size: 0.75rem;
        color: #212529;
        line-height: 1.3;
      }

      .results-table tr:hover {
        background: #f8f9fa;
      }

      .results-table th:first-child,
      .results-table td:first-child {
        width: 25px;
        text-align: center;
        font-weight: 600;
        color: #0d6efd;
        background: #f8f9fa;
        padding: 8px 2px;
      }

      .results-table th:first-child {
        background: #e7f3ff;
        color: #0c63e4;
      }

      .loading {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
        display: none;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid #f3f3f3;
        border-top: 4px solid #0d6efd;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 20px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .loading p {
        margin: 0;
        font-size: 0.875rem;
        color: #6c757d;
      }

      .status-message {
        background: #e3f2fd;
        border: 1px solid #2196f3;
        color: #1976d2;
        padding: 12px 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        display: none;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        font-size: 0.8rem;
        font-weight: 500;
        line-height: 1.3;
      }

      .error-message {
        background: #ffebee;
        border: 1px solid #f44336;
        color: #c62828;
      }

      .success-message {
        background: #e8f5e8;
        border: 1px solid #4caf50;
        color: #2e7d32;
      }

      @keyframes cursor-blink {
        0%,
        50% {
          opacity: 1;
        }
        51%,
        100% {
          opacity: 0.3;
        }
      }

      /* Right Sidebar - Settings */
      .right-sidebar {
        width: 300px;
        background: #ffffff;
        border-left: 1px solid #dee2e6;
        overflow-y: auto;
        padding: 15px;
        flex-shrink: 0;
      }

      .right-sidebar h2 {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        color: #1a1a1a;
        font-size: 1.3rem;
        margin-bottom: 16px;
        font-weight: 700;
        letter-spacing: -0.02em;
        line-height: 1.2;
        padding-bottom: 8px;
        border-bottom: 2px solid #0d6efd;
      }

      .settings-group {
        margin-bottom: 15px;
      }

      .settings-group h3 {
        font-family: "JetBrains Mono", "Courier New", monospace;
        color: #495057;
        font-size: 0.9rem;
        margin-bottom: 6px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.6px;
        line-height: 1.2;
      }

      .settings-group label {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        display: block;
        margin-bottom: 3px;
        font-weight: 500;
        color: #495057;
        font-size: 0.8rem;
        line-height: 1.3;
      }

      .settings-group input,
      .settings-group select {
        width: 100%;
        padding: 6px 10px;
        border: 1px solid #ced4da;
        border-radius: 6px;
        font-size: 0.8rem;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        font-weight: 400;
        transition: all 0.15s ease;
        background: #ffffff;
        color: #212529;
        margin-bottom: 6px;
        line-height: 1.3;
      }

      .settings-group input:focus,
      .settings-group select:focus {
        outline: none;
        border-color: #0d6efd;
        box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.1);
      }

      .save-btn {
        background: rgba(13, 110, 253, 0.8);
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.15s ease;
        width: 100%;
        margin-top: 6px;
        line-height: 1.3;
        letter-spacing: 0.01em;
      }

      .save-btn:hover {
        background: rgba(13, 110, 253, 0.9);
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(13, 110, 253, 0.25);
      }

      /* Field highlighting for validation */
      .settings-group input.error-field {
        border-color: #dc3545;
        background-color: #fff5f5;
        box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.1);
      }

      .settings-group input.warning-field {
        border-color: #ffc107;
        background-color: #ffffff;
        box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.1);
      }

      .field-error {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          Roboto, "Helvetica Neue", Arial, sans-serif;
        color: #dc3545;
        font-size: 0.7rem;
        margin-top: 4px;
        min-height: 16px;
        font-weight: 500;
        display: none;
        line-height: 1.3;
      }

      .field-error.show {
        display: block;
      }

      .field-error.error {
        color: #dc3545;
      }

      .field-error.warning {
        color: #ffc107;
      }

      .field-error.info {
        color: #0d6efd;
      }

      .field-error.success {
        color: #198754;
      }

      .llm-status {
        margin-top: 8px;
        padding: 8px 12px;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 6px;
        transition: all 0.2s ease;
      }

      .llm-status.checking {
        background: #e3f2fd;
        color: #1976d2;
        border: 1px solid #bbdefb;
      }

      .llm-status.available {
        background: #e8f5e8;
        color: #2e7d32;
        border: 1px solid #c8e6c9;
      }

      .llm-status.unavailable {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ffcdd2;
      }

      .llm-status .status-text {
        font-size: 0.75rem;
        font-weight: 500;
      }

      .llm-status .status-icon {
        font-size: 0.8rem;
      }

      .field-help {
        font-size: 0.75rem;
        color: #6c757d;
        margin-top: 4px;
        font-style: italic;
        line-height: 1.3;
      }

      .validate-btn {
        background: rgba(13, 110, 253, 0.8);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 4px;
        font-size: 0.8rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.15s ease;
        width: 100%;
      }

      .validate-btn:hover {
        background: rgba(13, 110, 253, 0.9);
        transform: translateY(-1px);
        box-shadow: 0 2px 6px rgba(13, 110, 253, 0.25);
      }

      .settings-group label.error-label {
        color: #dc3545;
        font-weight: 600;
      }

      .settings-group label.warning-label {
        color: #856404;
        font-weight: 600;
      }

      /* Focus states for better UX */
      .settings-group input:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.1);
      }

      .settings-group input.error-field:focus {
        border-color: #dc3545;
        box-shadow: 0 0 0 2px rgba(220, 53, 69, 0.2);
      }

      .settings-group input.warning-field:focus {
        border-color: #ffc107;
        box-shadow: 0 0 0 2px rgba(255, 193, 7, 0.2);
      }

      /* Responsive Design */
      @media (max-width: 1200px) {
        .left-sidebar {
          width: 250px;
        }
        .right-sidebar {
          width: 300px;
        }
      }

      @media (max-width: 768px) {
        .app-container {
          flex-direction: column;
        }
        .left-sidebar,
        .right-sidebar {
          width: 100%;
          border-right: none;
          border-left: none;
          border-bottom: 1px solid #dee2e6;
        }
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- Left Sidebar - History -->
      <div class="left-sidebar">
        <h2>History</h2>
        <div id="historyList">
          <!-- History items will be populated here -->
        </div>
      </div>

      <!-- Main Content Area -->
      <div class="main-content">
        <div class="search-section">
          <h2>🔍 Search Configuration</h2>
          <form id="searchForm" class="search-form">
            <div class="form-group">
              <label for="query">Job Title/Keywords</label>
              <input type="text" id="query" name="query" value="" required />
            </div>
            <div class="form-group">
              <label for="location">Location</label>
              <input
                type="text"
                id="location"
                name="location"
                value=""
                required
              />
            </div>
            <div class="form-group full-width">
              <label for="remote">Remote Option</label>
              <select id="remote" name="remote">
                <option value="false">No Preference</option>
                <option value="true">Remote Only</option>
              </select>
            </div>
            <div class="form-group full-width">
              <label for="count">Number of Jobs</label>
              <input
                type="number"
                id="count"
                name="count"
                value="10"
                min="1"
                max="100"
              />
            </div>
            <button type="submit" class="search-btn" id="searchBtn">
              Start Search
            </button>
          </form>
        </div>

        <div class="history-viewer" id="historyViewer" style="display: none">
          <div class="history-viewer-header">
            <h2 id="historyViewerTitle">History Viewer</h2>
            <button class="close-viewer-btn" onclick="closeHistoryViewer()">
              ✕
            </button>
          </div>
          <div class="history-viewer-content" id="historyViewerContent">
            <!-- History content will be displayed here -->
          </div>
        </div>

        <div class="agent-workflow" id="agentWorkflow">
          <h2>🤖 Agent Workflow</h2>

          <div class="workflow-step" id="step1">
            <div class="step-icon pending" id="icon1">1</div>
            <div class="step-content">
              <h4>Planning</h4>
              <p>Creating todo list...</p>
            </div>
          </div>

          <div class="workflow-step" id="step2">
            <div class="step-icon pending" id="icon2">2</div>
            <div class="step-content">
              <h4>Search</h4>
              <p>Using SerpAPI...</p>
            </div>
          </div>

          <div class="workflow-step" id="step3">
            <div class="step-icon pending" id="icon3">3</div>
            <div class="step-content">
              <h4>Extract</h4>
              <p>Getting job details...</p>
            </div>
          </div>

          <div class="workflow-step" id="step4">
            <div class="step-icon pending" id="icon4">4</div>
            <div class="step-content">
              <h4>Process</h4>
              <p>Validating data...</p>
            </div>
          </div>

          <div class="workflow-step" id="step5">
            <div class="step-icon pending" id="icon5">5</div>
            <div class="step-content">
              <h4>Complete</h4>
              <p>Preparing results...</p>
            </div>
          </div>
        </div>

        <div class="status-message" id="statusMessage"></div>

        <div class="results-section" id="resultsSection">
          <div class="job-count" id="jobCount"></div>
          <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>Agent is working on your job search...</p>
          </div>
          <div class="table-container">
            <table class="results-table" id="resultsTable">
              <thead>
                <tr>
                  <th>S.N.</th>
                  <th>Company</th>
                  <th>Job Title</th>
                  <th>Location</th>
                  <th>Remote/Onsite</th>
                  <th>Technologies</th>
                  <th>Requirements</th>
                  <th>Posted Date</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="resultsBody">
                <!-- Results will be populated here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Right Sidebar - Settings -->
      <div class="right-sidebar">
        <h2>Settings</h2>

        <div class="settings-group">
          <h3>LLM Configuration</h3>
          <label for="llmProviderUrl">LLM Provider URL</label>
          <input
            type="text"
            id="llmProviderUrl"
            placeholder="Enter URL"
            value=""
          />

          <label for="apiKey">API Key</label>
          <input type="text" id="apiKey" placeholder="Enter API key" />
          <div class="field-error" id="apiKey-error"></div>

          <div class="llm-status" id="llmStatus" style="display: none">
            <small class="status-text"></small>
          </div>

          <label for="modelName">Model Name</label>
          <input
            type="text"
            id="modelName"
            placeholder="Enter model name"
            value="openai/gpt-oss-120b"
          />
          <div class="field-error" id="modelName-error"></div>

          <label for="temperature">Temperature</label>
          <input
            type="range"
            id="temperature"
            min="0"
            max="2"
            step="0.1"
            value="0.7"
          />
          <span id="tempValue">0.7</span>

          <label for="maxTokens">Max Tokens</label>
          <input
            type="number"
            id="maxTokens"
            value="4096"
            min="100"
            max="8192"
          />
        </div>

        <div class="settings-group">
          <h3>Search Configuration</h3>
          <label for="serpApiKey">SerpAPI Key</label>
          <input type="text" id="serpApiKey" placeholder="Enter SerpAPI key" />
          <div class="field-error" id="serpApiKey-error"></div>
        </div>

        <button class="save-btn" onclick="saveSettings()">
          💾 Save Settings
        </button>
      </div>
    </div>

    <script>
      console.log("🚀 Job Agent JavaScript loaded!");

      // Initialize the application
      document.addEventListener("DOMContentLoaded", () => {
        console.log("📋 DOM loaded, initializing...");
        loadHistory();
        loadSettings();
        setupEventListeners();
        console.log("✅ Initialization complete");
      });

      // Load search history
      async function loadHistory() {
        try {
          const response = await fetch("/api/history");
          if (response.ok) {
            const data = await response.json();
            displayHistory(data.files || []);
          }
        } catch (error) {
          console.error("Error loading history:", error);
        }
      }

      // Display history items
      function displayHistory(files) {
        const historyList = document.getElementById("historyList");

        if (files.length === 0) {
          historyList.innerHTML =
            '<p style="text-align: center; color: #6c757d; padding: 20px;">No previous searches found.</p>';
          return;
        }

        historyList.innerHTML = files
          .map(
            (file) => `
              <div class="history-item" onclick="viewHistoryFile('${file.filename}', '${file.downloadUrl}')" style="cursor: pointer;">
                <div class="history-info">
                  <h4>${file.filename}</h4>

                </div>
                <div class="history-actions" onclick="event.stopPropagation();">
                  <button class="download-toggle" onclick="toggleDownloadOptions('${file.filename}')">
                    📥
                  </button>
                  <button class="delete-btn" onclick="deleteHistoryFile('${file.filename}')">
                    🗑️
                  </button>
                  <div class="download-options" id="download-${file.filename}">
                    <a href="${file.downloadUrl}" class="download-btn txt" download>
                      📄 TXT
                    </a>

                  </div>
                </div>
              </div>
            `
          )
          .join("");
      }

      // Load settings from server
      async function loadSettings() {
        try {
          const response = await fetch("/api/settings");
          if (response.ok) {
            const data = await response.json();
            const settings = data.settings;

            if (settings.llmProviderUrl)
              document.getElementById("llmProviderUrl").value =
                settings.llmProviderUrl;
            if (settings.apiKey)
              document.getElementById("apiKey").value = settings.apiKey;
            if (settings.serpApiKey)
              document.getElementById("serpApiKey").value = settings.serpApiKey;
            if (settings.modelName)
              document.getElementById("modelName").value = settings.modelName;
            if (settings.temperature) {
              document.getElementById("temperature").value =
                settings.temperature;
              document.getElementById("tempValue").textContent =
                settings.temperature;
            }
            if (settings.maxTokens)
              document.getElementById("maxTokens").value = settings.maxTokens;

            // Check and display settings status
            checkSettingsStatus();
          }
        } catch (error) {
          console.error("Error loading settings:", error);
        }
      }

      // Check settings status and display warnings
      function checkSettingsStatus() {
        const validation = validateSettings();

        // Update search button status
        updateSearchButtonStatus(validation);

        // Don't automatically highlight fields - only highlight when search is attempted
        // highlightFields(validation.errorFields, validation.warningFields);
      }

      // Update search button status based on settings
      function updateSearchButtonStatus(validation) {
        const searchBtn = document.getElementById("searchBtn");

        // Only disable if there are actual errors, not warnings
        if (validation.errors.length > 0) {
          searchBtn.disabled = true;
          searchBtn.style.opacity = "0.6";
          searchBtn.style.cursor = "not-allowed";
        } else {
          searchBtn.disabled = false;
          searchBtn.style.opacity = "1";
          searchBtn.style.cursor = "pointer";
        }
      }

      // Show settings status with warnings/errors
      function showSettingsStatus(errors, warnings) {
        // Don't show any status messages - just highlight the fields
        // The visual field highlighting is sufficient
      }

      // Highlight fields with errors and warnings
      function highlightFields(errorFields, warningFields) {
        // Reset all fields to normal state
        const allInputs = document.querySelectorAll(".settings-group input");
        const allLabels = document.querySelectorAll(".settings-group label");

        allInputs.forEach((input) => {
          input.classList.remove("error-field", "warning-field");
        });

        allLabels.forEach((label) => {
          label.classList.remove("error-label", "warning-label");
        });

        // Highlight error fields
        errorFields.forEach((fieldId) => {
          const input = document.getElementById(fieldId);
          const label = document.querySelector(`label[for="${fieldId}"]`);

          if (input) {
            input.classList.add("error-field");
          }
          if (label) {
            label.classList.add("error-label");
          }
        });

        // Highlight warning fields
        warningFields.forEach((fieldId) => {
          const input = document.getElementById(fieldId);
          const label = document.querySelector(`label[for="${fieldId}"]`);

          if (input) {
            input.classList.add("warning-field");
          }
          if (label) {
            label.classList.add("warning-label");
          }
        });
      }

      // Validate required settings
      function validateSettings() {
        const warnings = [];
        const errors = [];
        const errorFields = [];
        const warningFields = [];

        // Check required API keys
        const llmProviderUrl = document
          .getElementById("llmProviderUrl")
          .value.trim();
        const apiKey = document.getElementById("apiKey").value.trim();
        const serpApiKey = document.getElementById("serpApiKey").value.trim();

        if (!serpApiKey) {
          warnings.push("SerpAPI Key is required for job search functionality");
          warningFields.push("serpApiKey");
        }

        if (!llmProviderUrl && !apiKey) {
          warnings.push("At least one LLM Provider URL or API Key is required");
          if (!llmProviderUrl) warningFields.push("llmProviderUrl");
          if (!apiKey) warningFields.push("apiKey");
        }

        // Check other required fields
        // Model name is not compulsory, so no validation needed

        return { warnings, errors, errorFields, warningFields };
      }

      // Validate settings only when search is attempted
      function validateSettingsForSearch() {
        const warnings = [];
        const errors = [];
        const errorFields = [];
        const warningFields = [];

        // Check required API keys
        const serpApiKey = document.getElementById("serpApiKey").value.trim();

        // Only check SerpAPI key since LLM configuration is already validated
        if (!serpApiKey) {
          warnings.push("SerpAPI Key is required for job search functionality");
          warningFields.push("serpApiKey");
        }

        return { warnings, errors, errorFields, warningFields };
      }

      // Highlight fields specifically for search validation (yellow borders only)
      function highlightFieldsForSearch(warningFields) {
        // Only add warning-field class to show yellow borders
        warningFields.forEach((fieldId) => {
          const input = document.getElementById(fieldId);
          if (input) {
            input.classList.add("warning-field");
          }
        });
      }

      // Clear field highlighting
      function clearFieldHighlighting() {
        const allInputs = document.querySelectorAll(".settings-group input");
        allInputs.forEach((input) => {
          input.classList.remove("error-field", "warning-field");
        });
      }

      // Display error message for a specific field
      function showFieldError(fieldId, message, type = "error") {
        const errorElement = document.getElementById(`${fieldId}-error`);
        if (errorElement) {
          errorElement.textContent = message;
          errorElement.className = `field-error show ${type}`;
        }
      }

      // Clear error message for a specific field
      function clearFieldError(fieldId) {
        const errorElement = document.getElementById(`${fieldId}-error`);
        if (errorElement) {
          errorElement.textContent = "";
          errorElement.className = "field-error";
        }
      }

      // Clear all field errors
      function clearAllFieldErrors() {
        const errorFields = ["llmProviderUrl", "apiKey", "serpApiKey"];
        errorFields.forEach((fieldId) => {
          clearFieldError(fieldId);
        });
      }

      // Validate API keys and show specific error messages
      async function validateAPIKeys() {
        clearAllFieldErrors();

        const llmProviderUrl = document
          .getElementById("llmProviderUrl")
          .value.trim();
        const apiKey = document.getElementById("apiKey").value.trim();
        const serpApiKey = document.getElementById("serpApiKey").value.trim();
        const modelName = document.getElementById("modelName").value.trim();

        // Validate LLM Provider URL and API Key
        if (llmProviderUrl || apiKey) {
          try {
            // Clear previous LLM status
            clearLLMStatus();

            // Check if it's a Groq API key
            if (apiKey && apiKey.startsWith("gsk_")) {
              // Groq key - no URL needed
              showFieldError(
                "llmProviderUrl",
                "✅ Groq API key detected - no URL needed",
                "success"
              );
              showLLMSuccess();
            } else if (apiKey && !llmProviderUrl) {
              // Non-Groq key but no URL
              showFieldError(
                "llmProviderUrl",
                "❌ Non-Groq API key provided but no URL",
                "error"
              );
              showLLMError("Non-Groq API key needs URL");
            } else if (apiKey && llmProviderUrl) {
              // Non-Groq key with URL - test if it works
              try {
                const testResponse = await fetch("/api/providers/test-llm", {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({ prompt: "Hello, test" }),
                });

                if (testResponse.ok) {
                  showFieldError(
                    "llmProviderUrl",
                    "✅ URL-based LLM provider is working",
                    "success"
                  );
                  showLLMSuccess();
                } else {
                  showFieldError(
                    "llmProviderUrl",
                    "❌ URL-based LLM provider configured but not working",
                    "error"
                  );
                  showLLMError("URL-based LLM provider not working");
                }
              } catch (testError) {
                showFieldError(
                  "llmProviderUrl",
                  "❌ URL-based LLM provider test failed",
                  "error"
                );
                showLLMError("URL-based LLM provider test failed");
              }
            } else {
              // No API key
              showFieldError(
                "llmProviderUrl",
                "❌ API key is required",
                "error"
              );
              showLLMError("API key is required");
            }
          } catch (error) {
            showFieldError(
              "llmProviderUrl",
              "❌ Failed to validate LLM provider",
              "error"
            );
            showLLMError("Failed to validate LLM provider");
          }
        } else {
          // No LLM credentials provided
          clearLLMStatus();
        }

        // Validate SerpAPI Key
        if (serpApiKey) {
          try {
            // Test SerpAPI with a simple search
            const response = await fetch("/api/search-jobs", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                query: "test",
                location: "test",
                remote: false,
                count: 1,
              }),
            });

            if (response.status === 401) {
              showFieldError(
                "serpApiKey",
                "❌ SerpAPI key is invalid or expired",
                "error"
              );
            } else if (response.status === 429) {
              showFieldError(
                "serpApiKey",
                "⚠️ SerpAPI rate limit exceeded",
                "warning"
              );
            } else if (response.ok) {
              showFieldError(
                "serpApiKey",
                "✅ SerpAPI key is valid",
                "success"
              );
            } else {
              showFieldError(
                "serpApiKey",
                "⚠️ SerpAPI key validation failed",
                "warning"
              );
            }
          } catch (error) {
            showFieldError(
              "serpApiKey",
              "❌ Failed to validate SerpAPI key",
              "error"
            );
          }
        }

        // Validate Model Name
        if (modelName) {
          const validModels = [
            "openai/gpt-oss-120b",
            "gpt-4o",
            "gpt-4o-mini",
            "gpt-4",
            "gpt-3.5-turbo",
            "claude-3.5-sonnet",
            "claude-3-opus",
            "claude-3-haiku",
            "llama-3.1-8b-instruct",
            "llama-3.1-70b-instruct",
            "deepseek-r1-distill-llama-70b",
            "gpt-oss-20b",
          ];

          if (!validModels.includes(modelName.toLowerCase())) {
            showFieldError(
              "modelName",
              "⚠️ Model name may not be supported",
              "warning"
            );
          } else {
            showFieldError("modelName", "✅ Model name is valid", "success");
          }
        }
      }

      // Save settings to server
      async function saveSettings() {
        try {
          // Clear any previous error messages
          clearAllFieldErrors();

          // Validate settings before saving
          const validation = validateSettings();

          if (validation.errors.length > 0) {
            showStatus(
              `❌ Configuration errors: ${validation.errors.join(", ")}`,
              "error"
            );
            return;
          }

          if (validation.warnings.length > 0) {
            if (
              !confirm(
                `⚠️ Warnings detected:\n${validation.warnings.join(
                  "\n"
                )}\n\nContinue saving settings?`
              )
            ) {
              return;
            }
          }

          const settings = {
            llmProviderUrl: document.getElementById("llmProviderUrl").value,
            apiKey: document.getElementById("apiKey").value,
            serpApiKey: document.getElementById("serpApiKey").value,
            modelName: document.getElementById("modelName").value,
            temperature: parseFloat(
              document.getElementById("temperature").value
            ),
            maxTokens: parseInt(document.getElementById("maxTokens").value),
          };

          const response = await fetch("/api/settings", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(settings),
          });

          if (response.ok) {
            const result = await response.json();
            showStatus("✅ Settings saved successfully", "success");

            // Validate API keys after saving
            await validateAPIKeys();
          } else {
            throw new Error("Failed to save settings");
          }
        } catch (error) {
          console.error("Error saving settings:", error);
          showStatus("❌ Failed to save settings", "error");
        }
      }

      // Setup event listeners
      function setupEventListeners() {
        // Temperature slider
        document
          .getElementById("temperature")
          .addEventListener("input", (e) => {
            document.getElementById("tempValue").textContent = e.target.value;
          });

        // Search form
        document
          .getElementById("searchForm")
          .addEventListener("submit", async (e) => {
            e.preventDefault();
            await startJobSearch();
          });

        // Settings validation on input
        const settingsInputs = ["llmProviderUrl", "apiKey", "serpApiKey"];
        settingsInputs.forEach((id) => {
          const element = document.getElementById(id);
          if (element) {
            element.addEventListener("input", () => {
              // Remove yellow border instantly when user types
              element.classList.remove("warning-field");

              // Clear error message when user types
              clearFieldError(id);

              // Debounce the validation to avoid too many checks
              clearTimeout(window.settingsValidationTimeout);
              window.settingsValidationTimeout = setTimeout(() => {
                checkSettingsStatus();
              }, 500);
            });
          }
        });
      }

      // Start job search
      async function startJobSearch() {
        // Clear any previous highlighting and errors
        clearFieldHighlighting();
        clearAllFieldErrors();

        // First validate the settings before auto-saving
        const llmProviderUrl = document
          .getElementById("llmProviderUrl")
          .value.trim();
        const apiKey = document.getElementById("apiKey").value.trim();
        const serpApiKey = document.getElementById("serpApiKey").value.trim();
        const modelName = document.getElementById("modelName").value.trim();
        const temperature = parseFloat(
          document.getElementById("temperature").value
        );
        const maxTokens = parseInt(document.getElementById("maxTokens").value);

        // Validate LLM configuration first
        let llmValidationPassed = false;

        if (apiKey) {
          if (apiKey.startsWith("gsk_")) {
            // Groq key - no URL needed
            llmValidationPassed = true;
            showStatus("✅ Groq API key detected", "success");
          } else if (llmProviderUrl) {
            // Non-Groq key with URL - test if it works
            try {
              showStatus("🔍 Testing LLM provider...", "info");
              const testResponse = await fetch("/api/providers/test-llm", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ prompt: "Hello, test" }),
              });

              if (testResponse.ok) {
                llmValidationPassed = true;
                showStatus("✅ LLM provider test successful", "success");
              } else {
                showStatus("❌ LLM provider test failed", "error");
                return;
              }
            } catch (testError) {
              showStatus("❌ LLM provider test failed", "error");
              return;
            }
          } else {
            // Non-Groq key but no URL
            showStatus("❌ Non-Groq API key needs URL", "error");
            return;
          }
        } else {
          showStatus("❌ API key is required", "error");
          return;
        }

        // If LLM validation passed, auto-save settings
        if (llmValidationPassed) {
          try {
            showStatus("💾 Auto-saving settings...", "info");

            const settings = {
              llmProviderUrl: llmProviderUrl,
              apiKey: apiKey,
              serpApiKey: serpApiKey,
              modelName: modelName,
              temperature: temperature,
              maxTokens: maxTokens,
            };

            const response = await fetch("/api/settings", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify(settings),
            });

            if (!response.ok) {
              throw new Error("Failed to save settings");
            }

            showStatus("✅ Settings auto-saved successfully", "success");

            // Small delay to show the success message
            await new Promise((resolve) => setTimeout(resolve, 500));
          } catch (error) {
            console.error("Error auto-saving settings:", error);
            showStatus("❌ Failed to auto-save settings", "error");
            return;
          }
        }

        // Check if required settings are configured for search
        const validation = validateSettingsForSearch();

        if (validation.warnings.length > 0) {
          // Show yellow borders for missing required fields
          highlightFieldsForSearch(validation.warningFields);
          showStatus(
            `⚠️ Please configure required fields: ${validation.warnings.join(
              ", "
            )}`,
            "warning"
          );
          return;
        }

        // Settings are already validated and saved, proceed with search
        const formData = new FormData(document.getElementById("searchForm"));
        const searchData = {
          query: formData.get("query"),
          location: formData.get("location"),
          remote: formData.get("remote") === "true",
          count: parseInt(formData.get("count")),
        };

        await performJobSearch(searchData);
      }

      // Perform job search
      async function performJobSearch(searchData) {
        try {
          // Show workflow
          document.getElementById("agentWorkflow").style.display = "block";
          document.getElementById("resultsSection").className =
            "results-section processing";
          document.getElementById("loading").style.display = "block";
          document.getElementById("resultsTable").style.display = "none";

          // Reset workflow steps
          resetWorkflowSteps();

          // Step 1: Planning
          await updateWorkflowStep(
            1,
            "active",
            "Planning",
            "Creating search strategy..."
          );

          // Step 2: Web Search
          await updateWorkflowStep(2, "active", "Search", "Using SerpAPI...");

          const response = await fetch("/api/search-jobs", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(searchData),
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const result = await response.json();

          if (result.success) {
            // Step 3: Data Extraction
            await updateWorkflowStep(
              3,
              "active",
              "Extract",
              "Getting job details..."
            );

            // Step 4: Processing
            await updateWorkflowStep(
              4,
              "active",
              "Process",
              "Validating data..."
            );

            // Step 5: Complete
            await updateWorkflowStep(
              5,
              "active",
              "Complete",
              "Preparing results..."
            );

            // Show results
            displayResults(result.jobs);
            showStatus(
              `✅ Found ${result.jobs.length} jobs successfully!`,
              "success"
            );

            // Refresh history
            loadHistory();
          } else {
            throw new Error(result.error || "Search failed");
          }
        } catch (error) {
          showStatus(`❌ Search failed: ${error.message}`, "error");
        }
      }

      // Update workflow step
      async function updateWorkflowStep(stepNum, status, title, description) {
        const step = document.getElementById(`step${stepNum}`);
        const icon = document.getElementById(`icon${stepNum}`);
        const content = step.querySelector(".step-content");

        step.className = "workflow-step";
        icon.className = "step-icon";

        step.classList.add(status);
        icon.classList.add(status);
        icon.textContent = stepNum;

        content.querySelector("h4").textContent = title;
        content.querySelector("p").textContent = description;

        // Mark previous steps as completed
        for (let i = 1; i < stepNum; i++) {
          const prevStep = document.getElementById(`step${i}`);
          const prevIcon = document.getElementById(`icon${i}`);
          if (prevStep && prevIcon) {
            prevStep.classList.remove("active");
            prevStep.classList.add("completed");
            prevIcon.classList.remove("active");
            prevIcon.classList.add("completed");
          }
        }
      }

      // Reset workflow steps
      function resetWorkflowSteps() {
        for (let i = 1; i <= 5; i++) {
          const step = document.getElementById(`step${i}`);
          const icon = document.getElementById(`icon${i}`);
          step.className = "workflow-step";
          icon.className = "step-icon pending";
          icon.textContent = i;
        }
      }

      // Display results
      function displayResults(jobs) {
        document.getElementById("agentWorkflow").style.display = "none";
        document.getElementById("resultsSection").className =
          "results-section complete";
        document.getElementById("loading").style.display = "none";
        document.getElementById("resultsTable").style.display = "table";

        const jobCount = document.getElementById("jobCount");
        jobCount.textContent = `🎯 Found ${jobs.length} Jobs`;

        const tbody = document.getElementById("resultsBody");
        tbody.innerHTML = jobs
          .map(
            (job, index) => `
              <tr>
                <td>${index + 1}</td>
                <td>${job.company || "N/A"}</td>
                <td>${job.jobTitle || "N/A"}</td>
                <td>${job.companyAddress || "N/A"}</td>
                <td>${job.remoteOnsite || "N/A"}</td>
                <td>${job.languageRequirements || "N/A"}</td>
                <td>${job.requirements || "N/A"}</td>
                <td>${job.postedDate || "N/A"}</td>
                <td>
                  <a href="${
                    job.url || "#"
                  }" target="_blank" style="color: #4facfe; text-decoration: none;">
                    🔗 Apply
                  </a>
                </td>
              </tr>
            `
          )
          .join("");
      }

      // Export functions
      async function exportToCSV() {
        // Implementation for CSV export
        showStatus("✅ CSV export functionality", "success");
      }

      async function exportToExcel() {
        // Implementation for Excel export
        showStatus("✅ Excel export functionality", "success");
      }

      async function exportToPDF() {
        // Implementation for PDF export
        showStatus("✅ PDF export functionality", "success");
      }

      // View history file in main area
      async function viewHistoryFile(filename, downloadUrl) {
        try {
          // Show history viewer
          document.getElementById("historyViewer").style.display = "block";
          document.getElementById("agentWorkflow").style.display = "none";
          document.getElementById("resultsSection").style.display = "none";

          // Highlight the currently viewed file in the history list
          const allHistoryItems = document.querySelectorAll(".history-item");
          allHistoryItems.forEach((item) => item.classList.remove("viewing"));

          const currentItem = document.querySelector(
            `[onclick*="${filename}"]`
          );
          if (currentItem) {
            currentItem.classList.add("viewing");
          }

          // Load file content
          const response = await fetch(downloadUrl);
          if (response.ok) {
            const content = await response.text();
            displayHistoryContent(filename, content);
          } else {
            throw new Error("Failed to load file content");
          }
        } catch (error) {
          console.error("Error loading history file:", error);
          document.getElementById(
            "historyViewerContent"
          ).innerHTML = `<p style="color: #dc3545;">❌ Error loading file: ${error.message}</p>`;
        }
      }

      // Display history content
      function displayHistoryContent(filename, content) {
        const viewerContent = document.getElementById("historyViewerContent");

        // Update the header to show which file is being viewed
        document.getElementById("historyViewerTitle").textContent = filename;

        // Parse and format the content
        const jobs = parseJobsFromContent(content);

        if (jobs && jobs.length > 0) {
          viewerContent.innerHTML = `
            <div class="history-jobs-table">
              <table class="results-table">
                <thead>
                  <tr>
                    <th>S.N.</th>
                    <th>Company</th>
                    <th>Job Title</th>
                    <th>Location</th>
                    <th>Work Type</th>
                    <th>Technologies</th>
                    <th>Posted Date</th>
                  </tr>
                </thead>
                <tbody>
                  ${jobs
                    .map(
                      (job, index) => `
                    <tr>
                      <td>${index + 1}</td>
                      <td>${job.company || "N/A"}</td>
                      <td>${job.jobTitle || "N/A"}</td>
                      <td>${job.companyAddress || "N/A"}</td>
                      <td>${job.remoteOnsite || "N/A"}</td>
                      <td>${job.languageRequirements || "N/A"}</td>
                      <td>${job.postedDate || "N/A"}</td>
                    </tr>
                  `
                    )
                    .join("")}
                </tbody>
              </table>
            </div>
          `;
        } else {
          viewerContent.innerHTML = `
            <div class="history-raw-content">
              <h4>Raw Content:</h4>
              <pre style="background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto; font-size: 0.8rem;">${content.substring(
                0,
                1000
              )}${content.length > 1000 ? "..." : ""}</pre>
            </div>
          `;
        }
      }

      // Parse jobs from content
      function parseJobsFromContent(content) {
        try {
          const jobs = [];
          const jobBlocks = content.split(/-{30}/);

          for (const block of jobBlocks) {
            if (block.trim().length === 0) continue;

            const job = {};
            const lines = block.split("\n");

            for (const line of lines) {
              if (line.includes("🏢 Company:")) {
                job.company = line.split("🏢 Company:")[1]?.trim() || "N/A";
              } else if (line.includes("💼 Position:")) {
                job.jobTitle = line.split("💼 Position:")[1]?.trim() || "N/A";
              } else if (line.includes("📍 Location:")) {
                job.companyAddress =
                  line.split("📍 Location:")[1]?.trim() || "N/A";
              } else if (line.includes("🌐 Work Type:")) {
                job.remoteOnsite =
                  line.split("🌐 Work Type:")[1]?.trim() || "N/A";
              } else if (line.includes("💻 Technologies:")) {
                job.languageRequirements =
                  line.split("💻 Technologies:")[1]?.trim() || "N/A";
              } else if (line.includes("📅 Posted:")) {
                job.postedDate = line.split("📅 Posted:")[1]?.trim() || "N/A";
              }
            }

            if (Object.keys(job).length > 0) {
              jobs.push(job);
            }
          }

          return jobs;
        } catch (error) {
          console.error("Error parsing jobs:", error);
          return null;
        }
      }

      // Delete history file
      async function deleteHistoryFile(filename) {
        if (confirm(`Are you sure you want to delete "${filename}"?`)) {
          try {
            const response = await fetch(
              `/api/history/${encodeURIComponent(filename)}`,
              {
                method: "DELETE",
              }
            );

            if (response.ok) {
              const result = await response.json();
              showStatus(
                `✅ File "${filename}" deleted successfully`,
                "success"
              );
              // Refresh history list
              loadHistory();

              // If we're currently viewing this file, close the viewer
              const currentViewer = document.getElementById("historyViewer");
              if (currentViewer.style.display === "block") {
                const viewerTitle = document.querySelector(
                  ".history-viewer-header h2"
                );
                if (viewerTitle && viewerTitle.textContent.includes(filename)) {
                  closeHistoryViewer();
                }
              }
            } else {
              const errorData = await response.json().catch(() => ({}));
              throw new Error(
                errorData.error ||
                  `HTTP ${response.status}: ${response.statusText}`
              );
            }
          } catch (error) {
            console.error("Error deleting file:", error);
            showStatus(`❌ Failed to delete file: ${error.message}`, "error");
          }
        }
      }

      // Close history viewer
      function closeHistoryViewer() {
        document.getElementById("historyViewer").style.display = "none";
        document.getElementById("agentWorkflow").style.display = "none";
        document.getElementById("resultsSection").style.display = "block";
        // Reset the header title
        document.getElementById("historyViewerTitle").textContent =
          "History Viewer";
        // Remove highlighting from all history items
        const allHistoryItems = document.querySelectorAll(".history-item");
        allHistoryItems.forEach((item) => item.classList.remove("viewing"));
      }

      // Toggle download options
      function toggleDownloadOptions(filename) {
        const downloadOptions = document.getElementById(`download-${filename}`);
        const allOptions = document.querySelectorAll(".download-options");

        // Close all other open dropdowns
        allOptions.forEach((option) => {
          if (option !== downloadOptions) {
            option.classList.remove("show");
          }
        });

        // Toggle current dropdown
        downloadOptions.classList.toggle("show");
      }

      // Close download options when clicking outside
      document.addEventListener("click", (e) => {
        if (!e.target.closest(".history-actions")) {
          const allOptions = document.querySelectorAll(".download-options");
          allOptions.forEach((option) => {
            option.classList.remove("show");
          });
        }
      });

      // Show status message
      function showStatus(message, type = "info") {
        const statusDiv = document.getElementById("statusMessage");
        statusDiv.textContent = message;
        statusDiv.className = `status-message ${type}-message`;
        statusDiv.style.display = "block";

        setTimeout(() => {
          statusDiv.style.display = "none";
        }, 5000);
      }

      // Update LLM status display
      function updateLLMStatus(status, message) {
        const llmStatus = document.getElementById("llmStatus");
        const statusText = llmStatus.querySelector(".status-text");

        // Remove all status classes
        llmStatus.classList.remove("checking", "available", "unavailable");

        // Add the appropriate status class
        llmStatus.classList.add(status);

        // Update the message
        statusText.textContent = message;

        // Show the status
        llmStatus.style.display = "flex";
      }

      // Show LLM error status after API call fails
      function showLLMError(errorMessage) {
        updateLLMStatus("unavailable", `⚠️ ${errorMessage}`);
      }

      // Show LLM success status after API call succeeds
      function showLLMSuccess() {
        updateLLMStatus("available", "✅ LLM provider working");
      }

      // Clear LLM status
      function clearLLMStatus() {
        const llmStatus = document.getElementById("llmStatus");
        llmStatus.style.display = "none";
        llmStatus.classList.remove("checking", "available", "unavailable");
      }
    </script>
  </body>
</html>
